Exploring the Governement shutdown data
========================================================

Let's start with trying to make sense of data...
From Toms' script I knwo that e have 3 tables:
t1 t4 and t3a.

t1 seems to be the operating cash balance
t4 is the Federal Tax deposit
t3 is the Public Dept transaction.

Rememebr is always good to read any doc availble that explains the data:
from the documentation:
T1 explains "how much money does Uncle Sam have in his checking account on any given day""

Now I want to explore a little bit the data.
TO chekc if they have the same data range for instance. Let's use some SQL.

```{r}
library(sqldf)
library(ggplot2)
library(scales)
setwd('/Users/carlotorniai/Dropbox/Zipfian/git/government-shutdown')
# Load all of the tables into R
.tables <- sqldf('SELECT tbl_name FROM sqlite_master', dbname = 'treasury_data.db')$tbl_name
for (.table in .tables) {
  if (!(.table %in% ls())) {
    .sql <- paste('SELECT * FROM', .table)
    assign(.table, sqldf(.sql, dbname = 'treasury_data.db'))
  }
}
# Let's try to experiment with some queries..
print('Min date in T1')
print(sqldf('SELECT MIN(date) FROM t1;'))
print('Max date in T1')
print(sqldf('SELECT MAX(date) FROM t1;'))
```

So we have data from 2005 until 2013.
Hopefull we will have the same date range in all the tables.
Let's check for isntance table 2
```{r}
# Let's try to experiment with some queries..
print ("Min date in T4")
print(sqldf("SELECT MIN(date) FROM t4;"))
print ("Max date in T4")
print(sqldf("SELECT MAX(date) FROM t4;"))
```

So it seems we have the same date range.
So in T1 we have the type of accounts for  operating cash balance.
These are under the column:
account or account row. Let's check the variosu types of accounts


```{r}
sql<- 'SELECT DISTINCT account from t1;'
print(sqldf(sql))
```

Now Let's plot the trend across the last 5 years
```{r}
# Let's get the data first
sql <- 'select * from t1 where account ="Federal Reserve Account" and date > "2011-01-01"'
federal_account_trend = sqldf(sql)
# Let's transform the dates in date
federal_account_trend$date <- as.Date(federal_account_trend$date)
# Let's plot and ad some axis
ggplot(federal_account_trend, aes(x = date, y=open_today)) + geom_line()
```

```{r}
sql <- 'select * from "t1" where date > "2013-09-01" and account = "Federal Reserve Account"'
d <- sqldf(sql)
qplot(x = date, y = open_today, data = d, geom = "point")
```

Ok let's try now ti have acomulative sum per year and visualize it as a barpolt
I have a filed which is year...
Also I have the open_fy which indicates for each account the opening balance for fiscal year.
So to have a rough trand over the years I can get just this value for each year in the table. 

I excluded the total of the accounts and I made sure to 
Review the table below.. Starting with the same query for just one year

```{r}
# Ok now i try to plot the different types of account per year one next to the ohter.
accounts <- sqldf('select distinct account, open_fy, year from t1 where is_total==0 and account <>"Total Opening Balance"')
p1 <- ggplot(accounts, aes(x=year, y=open_fy, group=account, fill=account)) + geom_bar(position="dodge", stat="identity") + xlab("Year") + ylab("Amount in Milions of US dollars") + labs(title = "Opening balance by account type between 2005 and 2013")

p2 <- p1 +  scale_y_continuous(labels = dollar) + scale_x_continuous(breaks=2005:2013)
# Here I want to try to use the scale on Y to display the dollar
# Now I want to add each entry 

p2
```
We can see how during the big financial crisis (2008-2011) everything went "off scale".
In particular notice the Supplementary Financing Program. 

Now I want  to go and see where this money went. In order to do this I want to analyze the data
of the withdrowals of money in table2.

Remeber that table t2 reports "what did Uncle Sam spend money on today, and how much"
So le'ts have a closer look at table 2.

Please note the description of the table about the is_total and is_net:

**is_total**: Binary flag field indicating whether the deposit or withdrawal represents a total figure (1) or sub-component that adds up to the total (0). Exclude rows marked (1) from sum queries to prevent double-counting.

**is_net**: Binary flag indicating whether the item represents a net of deposits and withdrawals (1) or just deposits or withdrawals (0). Treasury presents some programs separately on both sides of the ledger but nets others together, or lists them separately but later on begins netting them together. Use this flag to disambiguate between the two.

So here I need to pay more attention to execute my query.
```{r}
expenses_2005 <- sqldf('select  account, item, sum(today) from t2 where is_total==0 and year=2005 and transaction_type=="withdrawal" group by account, item order by fytd desc limit 20' )

```
expenses_2005 <- sqldf('select * from t2 where is_total==0 and year=2005 and transaction_type=="withdrawal" order by fytd desc limit 1000' )
```{r}
# Let's try not to use SQL now but to actually use R
expenses_crisis <- subset(t2, transaction_type=='withdrawal' & year>2008 & year<2011, select=c(date, year, item, today))

#Let's have a first line plot of all this with different colors
ggplot(expenses_crisis, aes(x=as.Date(date), y=today, group=item, colour=item)) +geom_point()
```

Clearly the granularity of the data we choose isn't great to understand what's going on.
Let's just group the total of expense by year by type.
```{r}
# aggdata <-aggregate(mtcars, by=list(cyl,vs),  FUN=mean, na.rm=TRUE)
attach(expenses_crisis)
expenses_crisis_agg <- aggregate(expenses_crisis, by=list(year), FUN=sum)
#expenses_crisis_agg<- aggregate(. ~ as.numeric(today), data=expenses_crisis, FUN=sum)
```

Then I want to ask: what did it change with government shoutdown in the first two weeks of October 2013?

In order to answer this question I want to have a look first of all at the 
withdrawls :
having an average of the expenses in the years between 2005 and 2012 in those 2 weeks and
See what have change in the first 2 weeks of OCtober.

Make sure to choose the right tables and the proper filtering of results.

